<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title></title>
		<script src="js/mui.js"></script>
		<link rel="stylesheet" type="text/css" href="../css/app.css" />
		<link href="css/mui.min.css" rel="stylesheet" />
		<script type="text/javascript" src="js/Common.js" ></script>
		<script type="text/javascript" src="js/app.js"></script>
		<script type="text/javascript" src="js/HttpCommon.js"></script>
		<script type="text/javascript" charset="UTF-8">
			var loginInfo;
			
			mui.init({
				keyEventBind: {
					backbutton: false,
					menubutton: false
				},
			});
			mui.plusReady(function() {

				var accountInput = document.getElementById('accountInput');
				var passwordInput = document.getElementById('passwordInput');
				document.getElementById('btnLogin').addEventListener('tap', login);
				var loginProgress = document.getElementById('loginProgress');

				loginFromLocal();
			});

			function loginFromLocal() {
				if(localStorage.getItem(KEY_ACCOUNT)){
					console.log('login from local');
					accountInput.value = localStorage.getItem(KEY_ACCOUNT);
					passwordInput.value = localStorage.getItem(KEY_PASSWORD);
					login();
				}
			};
			function login() {
				loginInfo = {
					account: accountInput.value,
					password: passwordInput.value
				};
				if(checkInput()) {
					muiPost(HTTP_LOGIN, loginInfo, loginSuccess);
				}
			};

			function checkInput() {
				if(loginInfo.account.length < 6) {
					mui.toast('账号最短为6位');
					return false;
				}
				if(loginInfo.password.length < 6) {
					mui.toast('密码最短为6位');
					return false;
				}
				return true;
			}

			function loginSuccess(data) {
				if(data.result == HTTP_RESULT_SUCCESS) {
					localStorage.setItem(KEY_ACCOUNT, loginInfo.account);
					localStorage.setItem(KEY_PASSWORD, loginInfo.password);
					localStorage.setItem(KEY_TOKEN, data.data);
					
					console.log('UserToken:' + data.data);
					
					muiOpenWindowWithoutWaiting('main.html');
					accountInput.value = '';
					passwordInput.value = '';
				} else {
					console.log(data.errInfo);
					mui.alert('账号或密码错误', '登录失败');
				}
			};
		</script>
		<style>
			
			.mui-input-row {
				margin-left: 60px;
				margin-right: 60px;
			}
			
			.mui-btn-block {
				width: 70%;
				margin-left: 50px;
				height: 50px;
				text-align: center;
			}
			
			.mui-content {
				margin-top: 100px;
			}
			
			#loginProgress {
				width: 100px;
				height: 100px;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<h1 class="mui-title">登录</h1>
		</header>
		<div class="mui-content">
			<div class="mui-input-row">
				<label>账号</label>
				<input id="accountInput" type="text" class="mui-input-clear" placeholder="请输入账号" />
				<hr />
			</div>
			<div class="mui-input-row" style="margin-top: 20px;">
				<label>密码</label>
				<input id="passwordInput" type="password" class="mui-input-password" placeholder="请输入密码" />
				<hr />
			</div>
			<button id="btnLogin" class="mui-btn mui-btn-block mui-btn-primary" style="margin-top: 50px;">登录</button>
			<!--<button id="loginProgress" type="button" class="mui-btn mui-btn-primary" data-loading-icon="mui-spinner mui-spinner-custom">dd</button>
			<button type="button" data-loading-icon="mui-spinner mui-spinner-custom" class="mui-btn mui-btn-primary">确认</button>-->
		</div>
	</body>

</html>